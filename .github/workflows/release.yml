# Use this workflow to trigger releases (stable, beta, nightly)
# Nightly releases are triggered automatically via schedule

name: Release

run-name: "${{ github.event_name == 'schedule' && 'Nightly release' || format('Release {0} (type: {1}, publish: {2}, latest: {3})', inputs.git-ref, inputs.release-type, inputs.publish, inputs.latest) }}"

on:
  workflow_dispatch:
    inputs:
      release-type:
        required: true
        type: choice
        default: nightly
        description: "Type of release"
        options:
          - nightly
          - versioned
      git-ref:
        required: true
        type: string
        default: main
        description: "The git ref of this release"
      release-version:
        required: false
        type: string
        description: "Version to release (e.g., 3.0.0-beta.1). Required for versioned releases."
      update-main:
        required: false
        type: boolean
        default: false
        description: "[Versioned only] Create PR to update main branch (for phase transitions)"
      latest:
        required: false
        type: boolean
        default: false
        description: "[Versioned only] Make this the latest release"
      extra-features:
        required: false
        type: string
        default: storage-tikv,jwks,ml
        description: "Extra features enabled in the binary"
      publish:
        required: false
        type: boolean
        default: false
        description: "Publish the release"
  schedule:
    - cron: "0 0 * * *"

defaults:
  run:
    shell: bash

permissions:
  contents: write
  pull-requests: write

jobs:
  # ----------------------------------------
  # Validate inputs
  # ----------------------------------------

  validate-inputs:
    name: Validate inputs
    runs-on: ubuntu-latest
    steps:
      - name: Validate release inputs
        shell: bash
        run: |
          if [[ "${{ inputs.release-type }}" == "versioned" ]]; then
            if [[ -z "${{ inputs.release-version }}" ]]; then
              echo "Error: 'release-version' is required when release-type is 'versioned'"
              echo "Please provide a version number (e.g., 3.0.0-beta.1)"
              exit 1
            fi
          fi

          if [[ "${{ inputs.release-type }}" == "nightly" ]]; then
            if [[ -n "${{ inputs.release-version }}" ]]; then
              echo "Warning: 'release-version' is ignored for nightly releases"
            fi
            if [[ "${{ inputs.update-main }}" == "true" ]]; then
              echo "Warning: 'update-main' is ignored for nightly releases"
            fi
            if [[ "${{ inputs.latest }}" == "true" ]]; then
              echo "Warning: 'latest' is ignored for nightly releases"
            fi
          fi

  # ----------------------------------------
  # Bump version (optional)
  # ----------------------------------------

  bump-version:
    needs: [validate-inputs]
    name: Bump version
    if: ${{ inputs.release-type == 'versioned' }}
    runs-on: ubuntu-latest
    outputs:
      release-branch: ${{ steps.bump.outputs.release-branch }}
    steps:
      - name: Checkout sources
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ inputs.git-ref }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup environment
        uses: ./.github/actions/setup-environment

      - name: Install cargo-edit
        run: cargo install cargo-edit

      - name: Bump version and commit
        id: bump
        run: |
          set -e

          VERSION="${{ inputs.release-version }}"
          RELEASE_BRANCH="release/v${VERSION}"

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create release branch
          git checkout -b "${RELEASE_BRANCH}"

          # Bump version in workspace
          cargo set-version --workspace "${VERSION}"
          # Update lock file (only touch workspace crates, not dependencies)
          cargo update -p surrealdb -p surrealdb-core -p surrealdb-server

          # Commit changes
          git add Cargo.toml Cargo.lock crates/*/Cargo.toml profiling/Cargo.toml
          git commit -m "Prepare v${VERSION} release"

          # Push branch (tag will be created later after successful release)
          git push origin "${RELEASE_BRANCH}"

          echo "release-branch=${RELEASE_BRANCH}" >> $GITHUB_OUTPUT

      - name: Create PR to update main
        if: ${{ inputs.update-main == true && inputs.release-type == 'versioned' }}
        run: |
          gh pr create \
            --base main \
            --head ${{ steps.bump.outputs.release-branch }} \
            --title "chore: release v${{ inputs.release-version }}" \
            --body "Automated version bump for release v${{ inputs.release-version }}.

          **This PR updates the main branch to reflect the new release version.**

          - Version: `${{ inputs.release-version }}`
          - Release branch: `${{ steps.bump.outputs.release-branch }}`

          Review and merge this PR to update the main branch version for the next development cycle."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ----------------------------------------
  # Prepare release variables
  # ----------------------------------------

  prepare-vars:
    name: Prepare vars
    needs: [validate-inputs, bump-version]
    if: ${{ always() && needs.validate-inputs.result == 'success' }}
    runs-on: ubuntu-latest
    outputs:
      name: ${{ steps.vars.outputs.name }}
      version: ${{ steps.vars.outputs.version }}
      pre-release: ${{ steps.vars.outputs.pre-release }}
      release-name: ${{ steps.vars.outputs.release-name }}
      build-metadata: ${{ steps.vars.outputs.build-metadata }}
      git-ref: ${{ steps.config.outputs.git-ref }}
      nightly-release: ${{ steps.config.outputs.nightly-release }}
      latest: ${{ steps.config.outputs.latest }}
      extra-features: ${{ steps.config.outputs.extra-features }}
      publish: ${{ steps.config.outputs.publish }}
    steps:
      - name: Determine configuration
        id: config
        run: |
          if [[ "${{ github.event_name }}" == "schedule" ]]; then
            # Nightly scheduled release
            echo "git-ref=main" >> $GITHUB_OUTPUT
            echo "nightly-release=true" >> $GITHUB_OUTPUT
            echo "latest=false" >> $GITHUB_OUTPUT
            echo "extra-features=storage-tikv,jwks,ml" >> $GITHUB_OUTPUT
            echo "publish=true" >> $GITHUB_OUTPUT
          else
            # Manual workflow dispatch
            # If version was bumped, use the release branch
            if [[ "${{ needs.bump-version.result }}" == "success" ]] && [[ -n "${{ needs.bump-version.outputs.release-branch }}" ]]; then
              echo "git-ref=${{ needs.bump-version.outputs.release-branch }}" >> $GITHUB_OUTPUT
            else
              echo "git-ref=${{ inputs.git-ref }}" >> $GITHUB_OUTPUT
            fi
            # Derive nightly-release from release-type
            if [[ "${{ inputs.release-type }}" == "nightly" ]]; then
              echo "nightly-release=true" >> $GITHUB_OUTPUT
              # Force latest to false for nightly releases
              echo "latest=false" >> $GITHUB_OUTPUT
            else
              echo "nightly-release=false" >> $GITHUB_OUTPUT
              # Respect latest input for versioned releases
              echo "latest=${{ inputs.latest }}" >> $GITHUB_OUTPUT
            fi
            echo "extra-features=${{ inputs.extra-features }}" >> $GITHUB_OUTPUT
            echo "publish=${{ inputs.publish }}" >> $GITHUB_OUTPUT
          fi

      - name: Checkout sources
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ steps.config.outputs.git-ref }}

      - name: Prepare release variables
        id: vars
        uses: ./.github/actions/prepare-release-vars
        with:
          nightly-release: ${{ steps.config.outputs.nightly-release }}

  # ----------------------------------------
  # Quality checks
  # ----------------------------------------

  format:
    name: Check format
    needs: [ prepare-vars ]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ needs.prepare-vars.outputs.git-ref }}

      - name: Check format
        uses: ./.github/actions/quality-format

  clippy:
    name: Check clippy
    needs: [ prepare-vars ]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ needs.prepare-vars.outputs.git-ref }}

      - name: Check clippy
        uses: ./.github/actions/quality-clippy

  check:
    name: Check workspace
    needs: [ prepare-vars ]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ needs.prepare-vars.outputs.git-ref }}

      - name: Check workspace
        uses: ./.github/actions/quality-check

  check-wasm:
    name: Check Wasm
    needs: [ prepare-vars ]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ needs.prepare-vars.outputs.git-ref }}

      - name: Check Wasm
        uses: ./.github/actions/quality-check-wasm

  check-docs:
    name: Check docs
    needs: [ prepare-vars ]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ needs.prepare-vars.outputs.git-ref }}

      - name: Check docs
        uses: ./.github/actions/quality-check-docs

  # ----------------------------------------
  # Workspace tests
  # ----------------------------------------

  test:
    name: Test workspace
    needs: [ prepare-vars ]
    runs-on: [ runner-amd64-2xlarge ]
    steps:
      - name: Checkout sources
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ needs.prepare-vars.outputs.git-ref }}

      - name: Test workspace
        uses: ./.github/actions/test-workspace

  # ----------------------------------------
  # Build release binaries
  # ----------------------------------------

  build:
    name: Build ${{ matrix.arch }} binary
    needs: [ prepare-vars ]
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux amd64
          - arch: x86_64-unknown-linux-gnu
            platform: amd64
            os: linux
            runner: [ runner-amd64-2xlarge ]
          # Linux arm64
          - arch: aarch64-unknown-linux-gnu
            platform: arm64
            os: linux
            runner: [ runner-arm64-2xlarge ]
          # macOS amd64
          - arch: x86_64-apple-darwin
            platform: amd64
            os: macos
            runner: macos-15
          # macOS arm64
          - arch: aarch64-apple-darwin
            platform: arm64
            os: macos
            runner: macos-15
          # Windows amd64
          - arch: x86_64-pc-windows-msvc
            platform: amd64
            os: windows
            runner: windows-2025
    steps:
      - name: Checkout sources
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ needs.prepare-vars.outputs.git-ref }}

      - name: Build Linux binary
        if: matrix.os == 'linux'
        uses: ./.github/actions/build-linux
        with:
          arch: ${{ matrix.arch }}
          platform: ${{ matrix.platform }}
          name: ${{ needs.prepare-vars.outputs.name }}
          build-metadata: ${{ needs.prepare-vars.outputs.build-metadata }}
          extra-features: ${{ needs.prepare-vars.outputs.extra-features }}
          upload: true
          release: true

      - name: Build macOS binary
        if: matrix.os == 'macos'
        uses: ./.github/actions/build-macos
        with:
          arch: ${{ matrix.arch }}
          platform: ${{ matrix.platform }}
          name: ${{ needs.prepare-vars.outputs.name }}
          build-metadata: ${{ needs.prepare-vars.outputs.build-metadata }}
          extra-features: ${{ needs.prepare-vars.outputs.extra-features }}
          upload: true
          release: true

      - name: Build Windows binary
        if: matrix.os == 'windows'
        uses: ./.github/actions/build-windows
        with:
          arch: ${{ matrix.arch }}
          platform: ${{ matrix.platform }}
          name: ${{ needs.prepare-vars.outputs.name }}
          build-metadata: ${{ needs.prepare-vars.outputs.build-metadata }}
          extra-features: ${{ needs.prepare-vars.outputs.extra-features }}
          upload: true
          release: true

  # ----------------------------------------
  # Publish crates
  # ----------------------------------------

  publish-crates:
    name: Publish crates
    needs: [ test, format, clippy, check, check-wasm, check-docs, build, prepare-vars ]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ needs.prepare-vars.outputs.git-ref }}

      - name: Publish crate
        uses: ./.github/actions/publish-crate
        with:
          publish: ${{ needs.prepare-vars.outputs.publish }}
          nightly-release: ${{ needs.prepare-vars.outputs.nightly-release }}
          cargo-registry-token: ${{ secrets.CARGO_REGISTRY_TOKEN }}

  # ----------------------------------------
  # Publish binaries
  # ----------------------------------------

  publish:
    name: Publish binaries
    permissions:
      contents: write
    needs: [ prepare-vars, publish-crates ]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          ref: ${{ needs.prepare-vars.outputs.git-ref }}

      - name: Publish binaries
        uses: ./.github/actions/publish-binaries
        with:
          name: ${{ needs.prepare-vars.outputs.name }}
          version: ${{ needs.prepare-vars.outputs.version }}
          pre-release: ${{ needs.prepare-vars.outputs.pre-release }}
          release-name: ${{ needs.prepare-vars.outputs.release-name }}
          publish: ${{ needs.prepare-vars.outputs.publish }}
          create-release: ${{ needs.prepare-vars.outputs.publish == 'true' && needs.prepare-vars.outputs.nightly-release != 'true' }}
          latest: ${{ needs.prepare-vars.outputs.latest == 'true' && needs.prepare-vars.outputs.nightly-release != 'true' }}
          git-ref: ${{ needs.prepare-vars.outputs.git-ref }}
          aws-access-key-id: ${{ secrets.AMAZON_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AMAZON_SECRET_KEY }}

  # ----------------------------------------
  # Docker images
  # ----------------------------------------

  docker-prepare:
    name: Prepare Docker build
    needs: [ prepare-vars, publish ]
    if: ${{ needs.prepare-vars.outputs.publish == 'true' }}
    runs-on: ubuntu-latest
    outputs:
      tag-prefix: ${{ steps.prepare.outputs.tag-prefix }}
      matrix: ${{ steps.prepare.outputs.matrix }}
    steps:
      - name: Checkout sources
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Prepare Docker build
        id: prepare
        uses: ./.github/actions/docker-prepare
        with:
          tag-prefix: ${{ needs.prepare-vars.outputs.name }}

  docker:
    name: Build ${{ matrix.name }} (${{ matrix.build-target }})
    needs: [ prepare-vars, publish, docker-prepare ]
    if: ${{ needs.prepare-vars.outputs.publish == 'true' }}
    environment: ${{ needs.prepare-vars.outputs.release-name }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.docker-prepare.outputs.matrix) }}
    steps:
      - name: Checkout sources
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Build and push Docker image
        uses: ./.github/actions/docker-build
        with:
          environment: ${{ needs.prepare-vars.outputs.release-name }}
          tag-prefix: ${{ needs.docker-prepare.outputs.tag-prefix }}
          build-target: ${{ matrix.build-target }}
          tag-suffix: ${{ matrix.tag-suffix }}
          push: true
          latest: ${{ needs.prepare-vars.outputs.latest == 'true' && needs.prepare-vars.outputs.nightly-release != 'true' }}
          docker-user: ${{ secrets.DOCKER_USER }}
          docker-pass: ${{ secrets.DOCKER_PASS }}

  # ----------------------------------------
  # macOS universal binary
  # ----------------------------------------

  package-macos:
    name: Package and publish macOS universal binary
    needs: [ prepare-vars, publish ]
    runs-on: macos-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Package macOS universal binary
        uses: ./.github/actions/package-macos-universal
        with:
          name: ${{ needs.prepare-vars.outputs.name }}
          publish: ${{ needs.prepare-vars.outputs.publish }}
          aws-access-key-id: ${{ secrets.AMAZON_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AMAZON_SECRET_KEY }}

  # ----------------------------------------
  # Propagate binaries
  # ----------------------------------------

  propagate:
    name: Propagate binaries to all regions
    if: ${{ needs.prepare-vars.outputs.publish == 'true' }}
    environment: ${{ needs.prepare-vars.outputs.release-name }}
    needs: [ publish, package-macos, prepare-vars ]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Propagate binaries
        uses: ./.github/actions/propagate-binaries
        with:
          aws-access-key-id: ${{ secrets.AMAZON_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AMAZON_SECRET_KEY }}

  # ----------------------------------------
  # Cleanup release branch
  # ----------------------------------------

  cleanup-release-branch:
    name: Delete release branch
    needs: [ bump-version, propagate, prepare-vars ]
    if: ${{ always() && needs.bump-version.outputs.release-branch != '' && needs.propagate.result == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Delete release branch
        run: |
          git push origin --delete "${{ needs.bump-version.outputs.release-branch }}"
