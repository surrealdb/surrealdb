name: 'Publish crate'
description: 'Publish crate to crates.io'

inputs:
  publish:
    description: 'Whether to publish (false for dry-run)'
    required: false
    default: 'false'
  nightly-release:
    description: 'Whether this is a nightly release'
    required: false
    default: 'true'
  cargo-registry-token:
    description: 'Token for publishing to crates.io'
    required: true

runs:
  using: 'composite'
  steps:
    - name: Setup environment
      uses: ./.github/actions/setup-environment

    - name: Install release-plz
      shell: bash
      run: |
        curl -L https://github.com/MarcoIeni/release-plz/releases/download/release-plz-v0.3.30/release-plz-x86_64-unknown-linux-gnu.tar.gz | sudo tar -xz -C /usr/bin
        sudo chmod +x /usr/bin/release-plz

    - name: Configure release-plz
      shell: bash
      run: |
        cat << EOF > /tmp/release-plz.toml
        [workspace]
        changelog_update = false
        git_release_enable = false
        semver_check = false
        git_tag_enable = false
        EOF

    - name: Publish the crate
      shell: bash
      env:
        CARGO_REGISTRY_TOKEN: ${{ inputs.cargo-registry-token }}
      run: |
        set -x

        # Create a temporary branch in case the git ref is not a branch
        git checkout -b crate

        if [[ "${{ inputs.publish }}" == "false" || "${{ inputs.nightly-release }}" == "true" ]]; then
          # Dry run - use cargo publish directly as it works better for testing
          cargo publish --workspace --dry-run
        else
          # Real publish - use release-plz for retry logic
          # If all crates are already published, release-plz will fail
          # We should treat this as success (idempotency)
          if ! release-plz release --config /tmp/release-plz.toml; then
            # Check if the failure was because everything is already published
            echo "release-plz failed, checking if all crates are already published..."

            # Get all workspace crates (exclude crates with publish = false)
            all_published=true
            for crate in $(cargo metadata --format-version 1 --no-deps | jq -r '.packages[] | select(.publish != []) | .name'); do
              version=$(cargo metadata --format-version 1 --no-deps | jq -r ".packages[] | select(.name == \"$crate\") | .version")
              echo "Checking if $crate@$version is published..."

              if ! cargo search "$crate" --limit 1 | grep -q "^$crate = \"$version\""; then
                echo "  $crate@$version is NOT published"
                all_published=false
                break
              else
                echo "  $crate@$version is already published"
              fi
            done

            if [[ "$all_published" == "true" ]]; then
              echo "All crates are already published. Treating as success (idempotent)."
              exit 0
            else
              echo "Some crates failed to publish. Failing."
              exit 1
            fi
          fi
        fi


