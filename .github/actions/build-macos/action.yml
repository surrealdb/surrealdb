name: 'Build macOS binary'
description: 'Build SurrealDB binary for macOS'

inputs:
  arch:
    description: 'Target architecture (x86_64-apple-darwin or aarch64-apple-darwin)'
    required: true
  platform:
    description: 'Platform name (amd64 or arm64)'
    required: true
  name:
    description: 'The name of output'
    required: true
  version-override:
    description: 'Version override (for nightly builds)'
    required: false
    default: ''
  build-metadata:
    description: 'Build metadata'
    required: false
    default: ''
  onnx-version:
    description: 'The ONNX library version'
    required: false
    default: '1.16.3'
  extra-features:
    description: 'Extra features enabled in the binary'
    required: false
    default: 'storage-tikv,jwks,ml'
  upload:
    description: 'Upload build artifacts'
    required: false
    default: 'true'
  release:
    description: 'Compile with release flag'
    required: false
    default: 'true'

outputs:
  artifact-name:
    description: 'Name of the uploaded artifact'
    value: surreal-${{ inputs.name }}.darwin-${{ inputs.platform }}

runs:
  using: 'composite'
  steps:
    - name: Setup environment
      uses: ./.github/actions/setup-environment
      with:
        targets: ${{ inputs.arch }}

    - name: Output package versions
      shell: bash
      run: |
        set -x
        set +e
        go version ; cargo version ; rustc --version ; cmake --version ; gcc --version ; g++ --version ; perl -v

    - name: Prepare dependencies
      shell: bash
      run: brew install protobuf

    - name: Determine ONNX architecture
      id: onnx
      shell: bash
      run: |
        if [[ "${{ inputs.platform }}" == "amd64" ]]; then
          echo "arch=x86_64" >> $GITHUB_OUTPUT
        else
          echo "arch=arm64" >> $GITHUB_OUTPUT
        fi

    - name: Install target (for cross-compilation)
      if: ${{ inputs.arch == 'x86_64-apple-darwin' }}
      shell: bash
      run: rustup target add x86_64-apple-darwin

    - name: Build binary
      shell: bash
      env:
        SURREAL_BUILD_VERSION: ${{ inputs.version-override }}
        SURREAL_BUILD_METADATA: ${{ inputs.build-metadata }}
      run: |
        set -x

        # Build
        extra_args=""
        compile_profile="debug"
        if [[ "${{ inputs.name }}" == "ci" && "${{ inputs.upload }}" == "false" ]]; then
          extra_args="${extra_args} --features ${{ inputs.extra-features }}"
        else
          extra_args="${extra_args} --features default"
          if [[ ! -z "${{ inputs.extra-features }}" ]]; then
            extra_args="${extra_args} --features ${{ inputs.extra-features }}"
          fi
        fi
        if [[ "${{ inputs.release }}" == "true" ]]; then
          extra_args="${extra_args} --release"
          compile_profile="release"
        fi

        # Download libonnxruntime's static library and tell ORT crate to use it
        mkdir /tmp/onnxruntime
        curl -sSL https://github.com/surrealdb/onnxruntime-build/releases/download/v${{ inputs.onnx-version }}/onnxruntime-osx-${{ steps.onnx.outputs.arch }}-static_lib-${{ inputs.onnx-version }}.tgz | \
          tar -xz -C /tmp/onnxruntime/
        export ORT_STRATEGY=system ORT_LIB_LOCATION=/tmp/onnxruntime/lib

        cargo build --no-default-features ${extra_args} --locked --target ${{ inputs.arch }}

        # Package
        cp target/${{ inputs.arch }}/${compile_profile}/surreal surreal
        ./surreal version
        tar -zcvf surreal-${{ inputs.name }}.darwin-${{ inputs.platform }}.tgz surreal
        echo $(shasum -a 256 surreal-${{ inputs.name }}.darwin-${{ inputs.platform }}.tgz | cut -f1 -d' ') > surreal-${{ inputs.name }}.darwin-${{ inputs.platform }}.txt

    - name: Upload artifacts
      if: ${{ inputs.upload == 'true' }}
      uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
      with:
        name: surreal-${{ inputs.name }}.darwin-${{ inputs.platform }}
        path: |
          surreal
          surreal-${{ inputs.name }}.darwin-${{ inputs.platform }}.tgz
          surreal-${{ inputs.name }}.darwin-${{ inputs.platform }}.txt
