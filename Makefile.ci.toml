[env]
RUSTFLAGS = { value = "--cfg tokio_unstable", condition = { env_not_set = [
    "RUSTFLAGS",
] } }
BENCH_WORKER_THREADS = { value = "1", condition = { env_not_set = [
    "BENCH_WORKER_THREADS",
] } }
BENCH_NUM_OPS = { value = "1000", condition = { env_not_set = [
    "BENCH_NUM_OPS",
] } }
BENCH_DURATION = { value = "30", condition = { env_not_set = [
    "BENCH_DURATION",
] } }
BENCH_SAMPLE_SIZE = { value = "10", condition = { env_not_set = [
    "BENCH_SAMPLE_SIZE",
] } }
BENCH_FEATURES = { value = "protocol-ws,kv-mem,kv-rocksdb,kv-surrealkv", condition = { env_not_set = [
    "BENCH_FEATURES",
] } }
# Used to speed up the scripting timeout test, otherwise the test takes 5 seconds.
SURREAL_SCRIPTING_MAX_TIME_LIMIT = { value = "500", condition = { env_not_set = [
    "SURREAL_SCRIPTING_MAX_TIME_LIMIT",
] } }
# Configure LLVM profiling output to go to target directory instead of repo root
LLVM_PROFILE_FILE = { value = "target/llvm-cov-target/%p-%m.profraw", condition = { env_not_set = [
    "LLVM_PROFILE_FILE",
] } }

# --------------------------------------------------
# Quality checks
# --------------------------------------------------

[tasks.ci-docs]
category = "CI - CHECK"
description = "Check documentation generation"
command = "cargo"
args = [
    "doc",
    "--no-deps",
    "--package",
    "surrealdb",
    "--features",
    "rustls,native-tls,protocol-ws,protocol-http,kv-mem,kv-rocksdb,kv-tikv,http,scripting,jwks",
]

[tasks.ci-fmt]
category = "CI - CHECK"
description = "Run code formatting checks"
toolchain = "${SURREAL_NIGHTLY_RUST_TOOLCHAIN}"
command = "cargo"
args = [
    "fmt",
    "--all",
    "--check",
]

[tasks.ci-check]
category = "CI - CHECK"
description = "Run code quality checks"
command = "cargo"
args = [
    "check",
    "--locked",
    "--workspace",
    "--all-targets",
    "--features",
    "${ALL_FEATURES}",
    "${@}",
]

[tasks.ci-check-release]
category = "CI - CHECK"
description = "Run code quality checks (release)"
command = "cargo"
args = [
    "check",
    "--release",
    "--locked",
    "--workspace",
    "--all-targets",
    "--features",
    "${ALL_FEATURES}",
]

[tasks.ci-clippy]
category = "CI - CHECK"
description = "Run clippy linting"
command = "cargo"
args = [
    "clippy",
    "--workspace",
    "--all-targets",
    "--features",
    "${ALL_FEATURES}",
    "--tests",
    "--benches",
    "--bins",
    "--",
    "-D",
    "warnings",
]

[tasks.ci-clippy-fix]
category = "CI - CHECK"
description = "Fix clippy lint issues"
command = "cargo"
args = [
    "clippy",
    "--workspace",
    "--all-targets",
    "--features",
    "${ALL_FEATURES}",
    "--tests",
    "--benches",
    "--bins",
    "--fix",
    "--allow-dirty",
]

[tasks.ci-clippy-release]
category = "CI - CHECK"
description = "Run code quality linting (release)"
command = "cargo"
args = [
    "clippy",
    "--workspace",
    "--all-targets",
    "--release",
    "--features",
    "${ALL_FEATURES}",
    "--tests",
    "--benches",
    "--bins",
    "--",
    "-D",
    "warnings",
]

[tasks.ci-feature-check]
category = "CI - CHECK"
description = "Verify each feature compiles individually"
run_task = { name = [
    "ci-feature-check-sdk",
    "ci-feature-check-core",
    "ci-feature-check-server",
], fork = true, parallel = true }

[tasks.ci-feature-check-sdk]
category = "CI - CHECK"
description = "Verify each SDK feature compiles individually"
install_crate = "cargo-hack"
env = { RUSTFLAGS = "-D warnings" }
command = "cargo"
args = [
    "hack",
    "check",
    "--package",
    "surrealdb",
    "--each-feature",
    "--exclude-features",
    "kv-indxdb",
    "--exclude-no-default-features",
]

[tasks.ci-feature-check-core]
category = "CI - CHECK"
description = "Verify each core feature compiles individually"
install_crate = "cargo-hack"
env = { RUSTFLAGS = "-D warnings" }
command = "cargo"
args = [
    "hack",
    "check",
    "--package",
    "surrealdb-core",
    "--each-feature",
    "--exclude-features",
    "kv-indxdb",
]

[tasks.ci-feature-check-server]
category = "CI - CHECK"
description = "Verify each server feature compiles individually (with storage-mem base)"
install_crate = "cargo-hack"
env = { RUSTFLAGS = "-D warnings" }
command = "cargo"
args = [
    "hack",
    "check",
    "--package",
    "surrealdb-server",
    "--each-feature",
    "--exclude-features",
    "storage-indxdb",
    "--include-features",
    "storage-mem",
    "--exclude-no-default-features",
]

[tasks.ci-unused-deps]
category = "CI - CHECK"
description = "Check for unused dependencies"
install_crate = "cargo-machete"
command = "cargo"
args = ["machete"]

[tasks.ci-check-wasm]
# Note: On Mac, Apple ships its own version of LLVM which does not cross-compile to WASM.
# To build this on a Mac, you need to install the upstream LLVM Clang.
# Steps:
# 1. Install LLVM from Homebrew: `brew install llvm`
# 2. Add the LLVM bin directory to your PATH: `echo 'export PATH="/opt/homebrew/opt/llvm/bin:$PATH"' >> ~/.zshrc`
category = "CI - CHECK"
description = "Run code quality checks (WASM)"
command = "cargo"
env = { RUSTFLAGS = '--cfg getrandom_backend="wasm_js"' }
args = [
    "check",
    "--locked",
    "--package",
    "surrealdb",
    "--features",
    "protocol-ws,protocol-http,kv-mem,kv-indxdb,http,jwks",
    "--target",
    "wasm32-unknown-unknown",
]

# --------------------------------------------------
# Integration Tests
# --------------------------------------------------

[tasks.ci-cli-integration]
category = "CI - INTEGRATION TESTS"
description = "Run CLI integration tests"
command = "cargo"
env = { RUST_BACKTRACE = 1, RUST_LOG = { value = "cli_integration=debug", condition = { env_not_set = [
    "RUST_LOG",
] } } }
args = [
    "test",
    "--locked",
    "--no-default-features",
    "--features",
    "storage-mem,storage-surrealkv,http,scripting,jwks,cli",
    "--workspace",
    "--test",
    "cli_integration",
    "--",
    "cli_integration",
]

[tasks.ci-http-integration]
category = "CI - INTEGRATION TESTS"
description = "Run HTTP integration tests"
command = "cargo"
env = { RUST_BACKTRACE = 1, RUST_LOG = { value = "http_integration=debug", condition = { env_not_set = [
    "RUST_LOG",
] } } }
args = [
    "test",
    "--locked",
    "--no-default-features",
    "--features",
    "storage-mem,jwks",
    "--workspace",
    "--test",
    "http_integration",
    "--",
    "http_integration",
]

[tasks.ci-ws-integration]
category = "CI - INTEGRATION TESTS"
description = "Run WebSocket integration tests"
command = "cargo"
env = { RUST_BACKTRACE = 1, RUST_LOG = { value = "ws_integration=debug", condition = { env_not_set = [
    "RUST_LOG",
] } } }
args = [
    "test",
    "--locked",
    "--no-default-features",
    "--features",
    "storage-mem",
    "--workspace",
    "--test",
    "ws_integration",
    "--",
    "ws_integration",
]

[tasks.ci-ml-integration]
category = "CI - INTEGRATION TESTS"
description = "Run ML integration tests"
command = "cargo"
env = { RUST_BACKTRACE = 1, RUST_LOG = { value = "cli_integration::common=debug", condition = { env_not_set = [
    "RUST_LOG",
] } } }
args = [
    "test",
    "--locked",
    "--features",
    "storage-mem,ml",
    "--workspace",
    "--test",
    "ml_integration",
    "--",
    "ml_integration",
    "--nocapture",
]

[tasks.ci-graphql-integration]
category = "CI - INTEGRATION TESTS"
description = "Run GraphQL integration tests"
command = "cargo"
env = { RUST_BACKTRACE = 1, RUST_LOG = { value = "cli_integration::common=debug", condition = { env_not_set = [
    "RUST_LOG",
] } } }
args = [
    "test",
    "--locked",
    "--features",
    "storage-mem",
    "--workspace",
    "--test",
    "graphql_integration",
    "--",
    "graphql_integration",
    "--nocapture",
]

# --------------------------------------------------
# API tests
# --------------------------------------------------

[tasks.test-api-integration]
private = true
command = "cargo"
env = { RUST_BACKTRACE = 1 }
args = [
    "nextest",
    "run",
    "--locked",
    "--package",
    "surrealdb",
    "--no-default-features",
    "--features",
    "${_TEST_FEATURES}",
    "--test",
    "api",
    "${@}",
]

[tasks.ci-api-integration]
private = true
env = { RUST_BACKTRACE = 1, _START_SURREALDB_PATH = "memory" }
run_task = { name = [
    "start-surrealdb",
    "test-api-integration",
    "stop-surrealdb",
], fork = true }

[tasks.ci-api-integration-all]
category = "CI - INTEGRATION TESTS"
description = "Run all integration tests"
dependencies = [
    "ci-api-integration-mem",
    "ci-api-integration-rocksdb",
    "ci-api-integration-surrealkv",
    "ci-api-integration-tikv",
    "ci-api-integration-http",
    "ci-api-integration-ws",
    "ci-api-integration-any",
]

#
# API tests with networked services
#

[tasks.ci-api-integration-any]
category = "CI - INTEGRATION TESTS"
description = "Run API integration tests with Any engine"
env = { _TEST_API_ENGINE = "any", _TEST_FEATURES = "protocol-http" }
run_task = "ci-api-integration"

[tasks.ci-api-integration-http]
category = "CI - INTEGRATION TESTS"
description = "Run API integration tests with the HTTP engine"
env = { _TEST_API_ENGINE = "http", _TEST_FEATURES = "protocol-http" }
run_task = "ci-api-integration"

[tasks.ci-api-integration-ws]
category = "CI - INTEGRATION TESTS"
description = "Run API integration tests with the WebSocket engine"
env = { _TEST_API_ENGINE = "ws", _TEST_FEATURES = "protocol-ws" }
run_task = "ci-api-integration"

#
# API tests with embedded services
#

[tasks.ci-api-integration-mem]
category = "CI - INTEGRATION TESTS"
description = "Run API integration tests with the in-memory engine"
env = { _TEST_API_ENGINE = "mem", _TEST_FEATURES = "kv-mem" }
run_task = { name = [
    "test-api-integration",
], fork = true, parallel = true }

[tasks.ci-api-integration-rocksdb]
category = "CI - INTEGRATION TESTS"
description = "Run API integration tests with the RocksDB engine"
env = { _TEST_API_ENGINE = "rocksdb", _TEST_FEATURES = "kv-rocksdb" }
run_task = { name = [
    "test-api-integration",
], fork = true, parallel = true }

[tasks.ci-api-integration-surrealkv]
category = "CI - INTEGRATION TESTS"
description = "Run API integration tests with the SurrealKV engine"
env = { _TEST_API_ENGINE = "surrealkv", _TEST_FEATURES = "kv-surrealkv" }
run_task = { name = [
    "test-api-integration",
], fork = true, parallel = false }

[tasks.ci-api-integration-tikv]
category = "CI - INTEGRATION TESTS"
description = "Run API integration tests with the TiKV engine"
env = { _TEST_API_ENGINE = "tikv", _TEST_FEATURES = "kv-tikv" }
run_task = { name = [
    "start-tikv",
    "test-api-integration",
    "stop-tikv",
], fork = true, parallel = false }

# --------------------------------------------------
# KVS tests
# --------------------------------------------------

[tasks.test-kvs]
private = true
command = "cargo"
env = { RUST_BACKTRACE = 1 }
args = [
    "nextest",
    "run",
    "--locked",
    "--package",
    "surrealdb-core",
    "--no-default-features",
    "--features",
    "${_TEST_FEATURES}",
    "--lib",
    "--",
    "kvs::tests",
]

[tasks.ci-kvs-mem]
category = "CI - INTEGRATION TESTS"
description = "Run KVS integration tests with the in-memory engine"
env = { _TEST_API_ENGINE = "mem", _TEST_FEATURES = "kv-mem" }
run_task = { name = [
    "test-kvs",
], fork = true, parallel = true }

[tasks.ci-kvs-rocksdb]
category = "CI - INTEGRATION TESTS"
description = "Run KVS integration tests with the RocksDB engine"
env = { _TEST_API_ENGINE = "file", _TEST_FEATURES = "kv-rocksdb", SURREAL_ROCKSDB_SST_MAX_ALLOWED_SPACE_USAGE = 10485760, SURREAL_ROCKSDB_WRITE_BUFFER_SIZE = 10240, SURREAL_ROCKSDB_WAL_SIZE_LIMIT = 1 }
run_task = { name = [
    "test-kvs",
], fork = true, parallel = true }

[tasks.ci-kvs-surrealkv]
category = "CI - INTEGRATION TESTS"
description = "Run KVS integration tests with the SurrealKV engine"
env = { _TEST_API_ENGINE = "surrealkv", _TEST_FEATURES = "kv-surrealkv" }
run_task = { name = [
    "test-kvs",
], fork = true, parallel = false }

[tasks.ci-kvs-tikv]
category = "CI - INTEGRATION TESTS"
description = "Run KVS integration tests with the TiKV engine"
env = { _TEST_API_ENGINE = "tikv", _TEST_FEATURES = "kv-tikv" }
run_task = { name = [
    "start-tikv",
    "test-kvs",
    "stop-tikv",
], fork = true, parallel = false }

# --------------------------------------------------
# Language tests
# --------------------------------------------------

[tasks.test-lang]
private = true
category = "CI - LANGUAGE TESTS"
description = "Run SurrealQL language tests with specified engine"
script = """
    #!/bin/bash -ex
    cd language-tests
    if [ "${_TEST_LANG_FEATURES}" != "" ]; then
        cargo build --features ${_TEST_LANG_FEATURES}
    else
        cargo build
    fi
    if [ "${_TEST_API_ENGINE}" = "surrealkv" ] || [ "${_TEST_API_ENGINE}" = "rocksdb" ] || [ "${_TEST_API_ENGINE}" = "tikv" ]; then
        ./target/debug/surrealql-test --color always run --no-wip --jobs 1 --backend ${_TEST_API_ENGINE}
    else
        ./target/debug/surrealql-test --color always run --no-wip --jobs 3 --backend ${_TEST_API_ENGINE}
    fi
"""

[tasks.ci-lang-test-all]
category = "CI - LANGUAGE TESTS"
description = "Run all language tests"
dependencies = [
    "ci-lang-test-mem",
    "ci-lang-test-rocksdb",
    "ci-lang-test-surrealkv",
    "ci-lang-test-tikv",
]

[tasks.ci-lang-test-mem]
category = "CI - LANGUAGE TESTS"
description = "Run SurrealQL language tests with the in-memory engine"
env = { _TEST_API_ENGINE = "memory", _TEST_LANG_FEATURES = "" }
run_task = { name = [
    "test-lang",
], fork = true, parallel = true }

[tasks.ci-lang-test-rocksdb]
category = "CI - LANGUAGE TESTS"
description = "Run SurrealQL language tests with the RocksDB engine"
env = { _TEST_API_ENGINE = "rocksdb", _TEST_LANG_FEATURES = "backend-rocksdb" }
run_task = { name = [
    "test-lang",
], fork = true, parallel = true }

[tasks.ci-lang-test-surrealkv]
category = "CI - LANGUAGE TESTS"
description = "Run SurrealQL language tests with the SurrealKV engine"
env = { _TEST_API_ENGINE = "surrealkv", _TEST_LANG_FEATURES = "backend-surrealkv" }
run_task = { name = [
    "test-lang",
], fork = true, parallel = false }

[tasks.ci-lang-test-tikv]
category = "CI - LANGUAGE TESTS"
description = "Run SurrealQL language tests with the TiKV engine"
env = { _TEST_API_ENGINE = "tikv", _TEST_LANG_FEATURES = "backend-tikv" }
run_task = { name = [
    "start-tikv",
    "test-lang",
    "stop-tikv",
], fork = true, parallel = false }

# --------------------------------------------------
# Workspace tests
# --------------------------------------------------

[tasks.ci-workspace-test]
category = "CI - WORKSPACE TESTS"
description = "Run workspace library tests"
command = "cargo"
env = { SURREAL_ROCKSDB_SST_MAX_ALLOWED_SPACE_USAGE = 10485760, SURREAL_ROCKSDB_WRITE_BUFFER_SIZE = 10240, SURREAL_ROCKSDB_WAL_SIZE_LIMIT = 1 }
args = [
    "nextest",
    "run",
    "--locked",
    "--no-default-features",
    "--features",
    "allocator,allocation-tracking,storage-mem,storage-rocksdb,scripting,http,jwks",
    "--workspace",
    "--",
    "--skip", "api_integration",
    "--skip", "cli_integration",
    "--skip", "http_integration",
    "--skip", "ws_integration",
    "--skip", "ml_integration",
    "--skip", "graphql_integration",
    "--skip", "database_upgrade",
]

# --------------------------------------------------
# Workspace tests
# --------------------------------------------------

[tasks.ci-workspace-full]
category = "CI - WORKSPACE TESTS"
description = "Run full workspace tests"
command = "cargo"
args = [
    "nextest",
    "run",
    "--locked",
    "--no-default-features",
    "--features",
    "allocator,allocation-tracking,storage-mem,scripting,http,jwks,cli,graphql",
    "--workspace",
]

[tasks.ci-workspace-full-with-server]
env = { _START_SURREALDB_PATH = "memory" }
category = "CI - WORKSPACE TESTS"
description = "Run full workspace tests, with a local SurrealDB server"
run_task = { name = [
    "start-surrealdb",
    "ci-workspace-full",
    "stop-surrealdb",
], fork = true }

# --------------------------------------------------
# Coverage checks
# --------------------------------------------------

[tasks.ci-workspace-coverage]
category = "CI - WORKSPACE TESTS"
description = "Run full workspace tests with code coverage"
command = "cargo"
env = { LLVM_PROFILE_FILE = "target/llvm-cov-target/%p-%m.profraw" }
args = [
    "llvm-cov",
    "nextest",
    "--lcov",
    "--output-path",
    "lcov.info",
    "--locked",
    "--no-default-features",
    "--features",
    "allocator,allocation-tracking,storage-mem,scripting,http,jwks",
    "--workspace",
    # Exclude surrealism packages due to wasmtime complexity and stdin loops
    "--exclude", "surrealism-runtime",
    "--exclude", "surrealism",
    "--exclude", "surrealism-macros",
    "--exclude", "surrealism-types",
    "--exclude", "demo",
]

[tasks.ci-workspace-coverage-with-server]
env = { _START_SURREALDB_PATH = "memory" }
category = "CI - WORKSPACE TESTS"
description = "Run full workspace tests with code coverage, and a local SurrealDB server"
run_task = { name = [
    "start-surrealdb",
    "ci-workspace-coverage",
    "stop-surrealdb",
], fork = true }

[tasks.ci-lang-test-coverage]
category = "CI - COVERAGE"
description = "Run language tests with code coverage for core crates"
script = """
    #!/bin/bash -ex
    cd language-tests
    
    # Set up LLVM coverage instrumentation environment
    eval "$(cargo llvm-cov show-env --export-prefix)"
    
    # Clean previous coverage artifacts
    cargo llvm-cov clean --workspace
    
    # Build language-tests with instrumentation
    cargo build
    
    # Run the language tests (this exercises surrealdb-core)
    ./target/debug/surrealql-test --color always run --no-wip --jobs 3 --backend memory
    
    # Generate coverage report, excluding the harness code
    cargo llvm-cov report \
        --lcov \
        --output-path ../language-tests-lcov.info \
        --ignore-filename-regex 'language-tests/src/'
"""

# --------------------------------------------------
# Services
# --------------------------------------------------

[tasks.build-surrealdb]
category = "CI - BUILD"
private = true
command = "cargo"
args = [
    "build",
    "--locked",
    "--no-default-features",
    "--features",
    "storage-mem",
]

[tasks.start-surrealdb]
category = "CI - SERVICES"
description = "Start a local SurrealDB server"
dependencies = ["build-surrealdb"]
script = """
    #!/bin/bash -ex

    target/debug/surreal start ${_START_SURREALDB_PATH} --allow-all --deny-guests &>/tmp/surrealdb-${_TEST_API_ENGINE}.log &

    echo $! > /tmp/surreal-${_TEST_API_ENGINE}.pid

    set +e
    echo "Waiting for surreal to be ready..."
    tries=0
    while [[ $tries < 5 ]]; do
            target/debug/surreal is-ready 2>/dev/null && echo "Ready!" && exit 0 || sleep 1
            tries=$((tries + 1))
    done

    echo "ERROR: Surreal is unhealthy!"
    exit 1
"""

[tasks.stop-surrealdb]
category = "CI - SERVICES"
description = "Stop the local SurrealDB server"
script = """
    #!/bin/bash -ex
    kill $(cat /tmp/surreal-${_TEST_API_ENGINE}.pid) || true
    sleep 5
    kill -9 $(cat /tmp/surreal-${_TEST_API_ENGINE}.pid) || true
"""

[tasks.start-tikv]
category = "CI - SERVICES"
description = "Start a local TiKV playground"
script = """
    #!/bin/bash -ex

	echo "Installing TiKV playground..."
    ${HOME}/.tiup/bin/tiup install pd tikv playground

    echo "Cleaning TiKV playground..."
    ${HOME}/.tiup/bin/tiup clean --all
    killall -q tiup-playground || true
    rm -rf ${HOME}/.tiup/data/testing

	echo "Starting TiKV playground..."
	nohup ${HOME}/.tiup/bin/tiup playground --mode tikv-slim --kv 1 --pd 1 --db 0 --ticdc 0 --tiflash 0 --without-monitor --tag "testing" > /tmp/tiup.log &

    set +e
	tries=0
	echo "Waiting for TiKV playground to start..."
	while [[ $tries -lt 5 ]]; do
		sleep 5
		echo "Displaying playground status..."
		if ! ${HOME}/.tiup/bin/tiup playground display >/dev/null; then
			tries=$((tries + 1));
			continue
		fi
		exit 0;
	done

	echo "PANIC: Couldn't start TiKV playground! Here are the logs for the last attempt:"
    cat /tmp/tiup.log

    exit 1
"""

[tasks.stop-tikv]
category = "CI - SERVICES"
description = "Stop the local TiKV playground"
script = """
    #!/bin/bash -ex

    echo "Cleaning TiKV playground..."
    ${HOME}/.tiup/bin/tiup clean --all
    killall -q tiup-playground || true
    rm -rf ${HOME}/.tiup/data/testing

    set +e
	tries=0
	echo "Waiting for TiKV playground to stop..."
	while [[ $tries -lt 5 ]]; do
		sleep 5
		echo "Displaying playground status..."
		if ${HOME}/.tiup/bin/tiup playground display >/dev/null; then
			tries=$((tries + 1));
			continue
		fi
		exit 0;
	done

	echo "PANIC: Couldn't stop TiKV playground! Here are the logs for the last attempt:"
    cat /tmp/tiup.log

    exit 1
"""

# --------------------------------------------------
# Benchmarks
# --------------------------------------------------

[tasks.ci-bench]
category = "CI - BENCHMARK"
description = "Run SurrealDB benchmarks"
command = "cargo"
args = [
    "bench",
    "--quiet",
    "--package",
    "surrealdb",
    "--no-default-features",
    "--features",
    "kv-mem,scripting,http,jwks",
    "${@}",
]

[tasks.bench-target]
private = true
category = "CI - BENCHMARK"
command = "cargo"
args = [
    "bench",
    "--package",
    "surrealdb",
    "--bench",
    "sdb",
    "--no-default-features",
    "--features",
    "${BENCH_FEATURES}",
    "${@}",
]

[tasks.bench-lib-mem]
category = "CI - BENCHMARK"
description = "Run library benchmarks with the in-memory engine"
env = { BENCH_DATASTORE_TARGET = "lib-mem" }
run_task = { name = ["bench-target"] }

[tasks.bench-lib-rocksdb]
category = "CI - BENCHMARK"
description = "Run library benchmarks with the RocksDB engine"
env = { BENCH_DATASTORE_TARGET = "lib-rocksdb" }
run_task = { name = ["bench-target"] }

[tasks.bench-lib-surrealkv]
category = "CI - BENCHMARK"
description = "Run library benchmarks with the SurrealKV engine"
env = { BENCH_DATASTORE_TARGET = "lib-surrealkv" }
run_task = { name = ["bench-target"] }

[tasks.bench-sdk-mem]
category = "CI - BENCHMARK"
description = "Run SDK benchmarks with the in-memory engine"
env = { BENCH_DATASTORE_TARGET = "sdk-mem" }
run_task = { name = ["bench-target"] }

[tasks.bench-sdk-rocksdb]
category = "CI - BENCHMARK"
description = "Run SDK benchmarks with the RocksDB engine"
env = { BENCH_DATASTORE_TARGET = "sdk-rocksdb" }
run_task = { name = ["bench-target"] }

[tasks.bench-sdk-surrealkv]
category = "CI - BENCHMARK"
description = "Run SDK benchmarks with the SurrealKV engine"
env = { BENCH_DATASTORE_TARGET = "sdk-surrealkv" }
run_task = { name = ["bench-target"] }

[tasks.bench-sdk-ws]
category = "CI - BENCHMARK"
description = "Run SDK benchmarks with the WebSocket engine"
env = { BENCH_DATASTORE_TARGET = "sdk-ws" }
run_task = { name = ["bench-target"] }

# --------------------------------------------------
# Run all required checks for PR merge
# --------------------------------------------------

[tasks.ci-sdk-build]
category = "CI - INTEGRATION TESTS"
description = "Build SDK test projects"
script = """
    #!/bin/bash -e
    echo "Building SDK local tests..."
    cd tests/sdk/local
    cargo build

    echo "Building SDK remote tests..."
    cd ../remote
    cargo build
"""

[tasks.ci-all-required]
category = "CI - ALL REQUIRED CHECKS"
description = "Run almost all required CI checks that must pass for PR merge"
dependencies = [
    # Code quality checks
    "ci-fmt",
    "ci-clippy",
    "ci-check",
    "ci-check-wasm",
    "ci-feature-check",
    "ci-unused-deps",
    "ci-docs",
    # Workspace tests
    "ci-workspace-test",
    # Integration tests
    "ci-cli-integration",
    "ci-http-integration",
    "ci-ws-integration",
    "ci-ml-integration",
    # KVS tests
    "ci-kvs-mem",
    "ci-kvs-rocksdb",
    "ci-kvs-surrealkv",
    # SDK build tests
    "ci-sdk-build",
    # SDK tests
    "ci-api-integration-mem",
    "ci-api-integration-rocksdb",
    "ci-api-integration-surrealkv",
    "ci-api-integration-http",
    "ci-api-integration-ws",
    "ci-api-integration-any",
    # Language tests
    "ci-lang-test-mem",
    "ci-lang-test-rocksdb",
    "ci-lang-test-surrealkv",
]
