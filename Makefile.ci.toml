[env]
RUSTFLAGS = { value = "--cfg tokio_unstable", condition = { env_not_set = [
    "RUSTFLAGS",
] } }
BENCH_WORKER_THREADS = { value = "1", condition = { env_not_set = [
    "BENCH_WORKER_THREADS",
] } }
BENCH_NUM_OPS = { value = "1000", condition = { env_not_set = [
    "BENCH_NUM_OPS",
] } }
BENCH_DURATION = { value = "30", condition = { env_not_set = [
    "BENCH_DURATION",
] } }
BENCH_SAMPLE_SIZE = { value = "10", condition = { env_not_set = [
    "BENCH_SAMPLE_SIZE",
] } }
BENCH_FEATURES = { value = "protocol-ws,kv-mem,kv-rocksdb,kv-surrealkv", condition = { env_not_set = [
    "BENCH_FEATURES",
] } }
# Used to speed up the scripting timeout test, otherwise the test takes 5 seconds.
SURREAL_SCRIPTING_MAX_TIME_LIMIT = { value = "500", condition = { env_not_set = [
    "SURREAL_SCRIPTING_MAX_TIME_LIMIT",
] } }
# Configure LLVM profiling output to go to target directory instead of repo root
LLVM_PROFILE_FILE = { value = "target/llvm-cov-target/%p-%m.profraw", condition = { env_not_set = [
    "LLVM_PROFILE_FILE",
] } }

[tasks.ci-format]
category = "CI - CHECK"
toolchain = "${SURREAL_NIGHTLY_RUST_TOOLCHAIN}"
command = "cargo"
args = ["fmt", "--all", "--check"]

[tasks.ci-check]
category = "CI - CHECK"
command = "cargo"
args = [
    "check",
    "--locked",
    "--workspace",
    "--all-targets",
    "--features",
    "${ALL_FEATURES}",
    "${@}",
]

[tasks.ci-check-release]
category = "CI - CHECK"
command = "cargo"
args = [
    "check",
    "--release",
    "--locked",
    "--workspace",
    "--all-targets",
    "--features",
    "${ALL_FEATURES}",
]

[tasks.ci-clippy]
category = "CI - CHECK"
command = "cargo"
args = [
    "clippy",
    "--workspace",
    "--all-targets",
    "--features",
    "${ALL_FEATURES}",
    "--tests",
    "--benches",
    "--bins",
    "--",
    "-D",
    "warnings",
]

[tasks.ci-clippy-release]
category = "CI - CHECK"
command = "cargo"
args = [
    "clippy",
    "--workspace",
    "--all-targets",
    "--release",
    "--features",
    "${ALL_FEATURES}",
    "--tests",
    "--benches",
    "--bins",
    "--",
    "-D",
    "warnings",
]

[tasks.ci-check-wasm]
# Note: On Mac, Apple ships its own version of LLVM which does not cross-compile to WASM.
# To build this on a Mac, you need to install the upstream LLVM Clang.
# Steps:
# 1. Install LLVM from Homebrew: `brew install llvm`
# 2. Add the LLVM bin directory to your PATH: `echo 'export PATH="/opt/homebrew/opt/llvm/bin:$PATH"' >> ~/.zshrc`
category = "CI - CHECK"
command = "cargo"
env = { RUSTFLAGS = '--cfg getrandom_backend="wasm_js"' }
args = [
    "check",
    "--locked",
    "--package",
    "surrealdb",
    "--features",
    "protocol-ws,protocol-http,kv-mem,kv-indxdb,http,jwks",
    "--target",
    "wasm32-unknown-unknown",
]

[tasks.ci-docs]
category = "CI - CHECK"
command = "cargo"
args = [
    "doc",
    "--no-deps",
    "--package",
    "surrealdb",
    "--features",
    "rustls,native-tls,protocol-ws,protocol-http,kv-mem,kv-rocksdb,kv-tikv,http,scripting,jwks",
]

#
# Integration Tests
#

[tasks.ci-cli-integration]
category = "CI - INTEGRATION TESTS"
command = "cargo"
env = { RUST_BACKTRACE = 1, RUST_LOG = { value = "cli_integration=debug", condition = { env_not_set = [
    "RUST_LOG",
] } } }
args = [
    "test",
    "--locked",
    "--no-default-features",
    "--features",
    "storage-mem,storage-surrealkv,http,scripting,jwks",
    "--workspace",
    "--test",
    "cli_integration",
    "--",
    "cli_integration",
]

[tasks.ci-http-integration]
category = "CI - INTEGRATION TESTS"
command = "cargo"
env = { RUST_BACKTRACE = 1, RUST_LOG = { value = "http_integration=debug", condition = { env_not_set = [
    "RUST_LOG",
] } } }
args = [
    "test",
    "--locked",
    "--no-default-features",
    "--features",
    "storage-mem,jwks",
    "--workspace",
    "--test",
    "http_integration",
    "--",
    "http_integration",
]

[tasks.ci-ws-integration]
category = "WS - INTEGRATION TESTS"
command = "cargo"
env = { RUST_BACKTRACE = 1, RUST_LOG = { value = "ws_integration=debug", condition = { env_not_set = [
    "RUST_LOG",
] } } }
args = [
    "test",
    "--locked",
    "--no-default-features",
    "--features",
    "storage-mem",
    "--workspace",
    "--test",
    "ws_integration",
    "--",
    "ws_integration",
]

[tasks.ci-ml-integration]
category = "ML - INTEGRATION TESTS"
command = "cargo"
env = { RUST_BACKTRACE = 1, RUST_LOG = { value = "cli_integration::common=debug", condition = { env_not_set = [
    "RUST_LOG",
] } } }
args = [
    "test",
    "--locked",
    "--features",
    "storage-mem,ml",
    "--workspace",
    "--test",
    "ml_integration",
    "--",
    "ml_integration",
    "--nocapture",
]

[tasks.ci-graphql-integration]
category = "GRAPHQL - INTEGRATION TESTS"
command = "cargo"
env = { RUST_BACKTRACE = 1, RUST_LOG = { value = "cli_integration::common=debug", condition = { env_not_set = [
    "RUST_LOG",
] } }, SURREAL_CAPS_ALLOW_EXPERIMENTAL = "graphql" }
args = [
    "test",
    "--locked",
    "--features",
    "storage-mem",
    "--workspace",
    "--test",
    "graphql_integration",
    "--",
    "graphql_integration",
    "--nocapture",
]

[tasks.ci-test-workspace]
category = "CI - INTEGRATION TESTS"
command = "cargo"
args = [
    "nextest",
    "run",
    "--locked",
    "--no-default-features",
    "--features",
    "allocator,allocation-tracking,storage-mem,scripting,http,jwks",
    "--workspace",
    "--",
    "--skip",
    "cli_integration",
]

[tasks.ci-workspace-coverage]
category = "CI - INTEGRATION TESTS"
command = "cargo"
env = { LLVM_PROFILE_FILE = "target/llvm-cov-target/%p-%m.profraw" }
args = [
    "llvm-cov",
    "--lcov",
    "--output-path",
    "lcov.info",
    "--locked",
    "--no-default-features",
    "--features",
    "allocator,allocation-tracking,storage-mem,scripting,http,jwks",
    "--workspace",
    "--no-fail-fast",
    "--",
    "--skip",
    "api_integration",
    "--skip",
    "cli_integration",
    "--skip",
    "http_integration",
    "--skip",
    "ws_integration",
    "--skip",
    "ml_integration",
    "--skip",
    "graphql_integration",
    "--skip",
    "database_upgrade",
]

[tasks.test-workspace-coverage-complete]
category = "CI - INTEGRATION TESTS"
command = "cargo"
env = { LLVM_PROFILE_FILE = "target/llvm-cov-target/%p-%m.profraw" }
args = [
    "llvm-cov",
    "--html",
    "--locked",
    "--no-default-features",
    "--features",
    "protocol-ws,protocol-http,kv-mem,kv-rocksdb",
    "--workspace",
]

[tasks.ci-workspace-coverage-complete]
env = { _START_SURREALDB_PATH = "memory" }
category = "CI - INTEGRATION TESTS"
run_task = { name = [
    "start-surrealdb",
    "test-workspace-coverage-complete",
    "stop-surrealdb",
], fork = true }

#
# Tests private tasks
#

[tasks.test-kvs]
private = true
command = "cargo"
env = { RUST_BACKTRACE = 1 }
args = [
    "nextest",
    "run",
    "--locked",
    "--package",
    "surrealdb-core",
    "--no-default-features",
    "--features",
    "${_TEST_FEATURES}",
    "--lib",
    "--",
    "kvs::tests",
]

[tasks.test-api-integration]
private = true
command = "cargo"
env = { RUST_BACKTRACE = 1 }
args = [
    "nextest",
    "run",
    "--locked",
    "--package",
    "surrealdb",
    "--no-default-features",
    "--features",
    "${_TEST_FEATURES}",
    "--test",
    "api",
    "${@}",
]

[tasks.ci-api-integration]
private = true
env = { RUST_BACKTRACE = 1, _START_SURREALDB_PATH = "memory" }
run_task = { name = [
    "start-surrealdb",
    "test-api-integration",
    "stop-surrealdb",
], fork = true }

#
# Integration tests with background services
#

[tasks.ci-api-integration-http]
category = "CI - INTEGRATION TESTS"
env = { _TEST_API_ENGINE = "http", _TEST_FEATURES = "protocol-http" }
run_task = "ci-api-integration"

[tasks.ci-api-integration-ws]
category = "CI - INTEGRATION TESTS"
env = { _TEST_API_ENGINE = "ws", _TEST_FEATURES = "protocol-ws", SURREAL_WEBSOCKET_MAX_MESSAGE_SIZE = 268435456 }
run_task = "ci-api-integration"

[tasks.ci-api-integration-any]
category = "CI - INTEGRATION TESTS"
env = { _TEST_API_ENGINE = "any", _TEST_FEATURES = "protocol-http" }
run_task = "ci-api-integration"

#
# Integration tests without background services
#
[tasks.ci-api-integration-mem]
category = "CI - INTEGRATION TESTS"
env = { _TEST_API_ENGINE = "mem", _TEST_FEATURES = "kv-mem" }
run_task = { name = [
    "test-api-integration",
], fork = true, parallel = true }

[tasks.ci-api-integration-rocksdb]
category = "CI - INTEGRATION TESTS"
env = { _TEST_API_ENGINE = "rocksdb", _TEST_FEATURES = "kv-rocksdb" }
run_task = { name = [
    "test-api-integration",
], fork = true, parallel = true }

[tasks.ci-api-integration-surrealkv]
category = "CI - INTEGRATION TESTS"
env = { _TEST_API_ENGINE = "surrealkv", _TEST_FEATURES = "kv-surrealkv" }
run_task = { name = [
    "test-api-integration",
], fork = true, parallel = false }

[tasks.ci-api-integration-tikv]
category = "CI - INTEGRATION TESTS"
env = { _TEST_API_ENGINE = "tikv", _TEST_FEATURES = "kv-tikv" }
run_task = { name = [
    "start-tikv",
    "test-api-integration",
    "stop-tikv",
], fork = true, parallel = false }

[tasks.ci-api-integration-fdb]
category = "CI - INTEGRATION TESTS"
env = { _TEST_API_ENGINE = "fdb", _TEST_FEATURES = "kv-fdb" }
run_task = { name = [
    "test-api-integration",
], fork = true, parallel = false }

[tasks.ci-api-integration-all]
category = "CI - INTEGRATION TESTS"
description = "Run all integration tests"
dependencies = [
    "ci-api-integration-mem",
    "ci-api-integration-rocksdb",
    "ci-api-integration-surrealkv",
    "ci-api-integration-tikv",
    "ci-api-integration-fdb",
    "ci-api-integration-http",
    "ci-api-integration-ws",
]

#
# KVS tests
#
[tasks.ci-mem-kvs]
category = "CI - INTEGRATION TESTS"
env = { _TEST_API_ENGINE = "mem", _TEST_FEATURES = "kv-mem" }
run_task = { name = [
    "test-kvs",
], fork = true, parallel = true }

[tasks.ci-rocksdb-kvs]
category = "CI - INTEGRATION TESTS"
env = { _TEST_API_ENGINE = "file", _TEST_FEATURES = "kv-rocksdb", SURREAL_ROCKSDB_SST_MAX_ALLOWED_SPACE_USAGE = 10485760, SURREAL_ROCKSDB_WRITE_BUFFER_SIZE = 10240, SURREAL_ROCKSDB_WAL_SIZE_LIMIT = 1 }
run_task = { name = [
    "test-kvs",
], fork = true, parallel = true }

[tasks.ci-surrealkv-kvs]
category = "CI - INTEGRATION TESTS"
env = { _TEST_API_ENGINE = "surrealkv", _TEST_FEATURES = "kv-surrealkv" }
run_task = { name = [
    "test-kvs",
], fork = true, parallel = false }

[tasks.ci-tikv-kvs]
category = "CI - INTEGRATION TESTS"
env = { _TEST_API_ENGINE = "tikv", _TEST_FEATURES = "kv-tikv" }
run_task = { name = [
    "start-tikv",
    "test-kvs",
    "stop-tikv",
], fork = true, parallel = false }

[tasks.ci-fdb-kvs]
category = "CI - INTEGRATION TESTS"
env = { _TEST_API_ENGINE = "fdb", _TEST_FEATURES = "kv-fdb" }
run_task = { name = [
    "test-kvs",
], fork = true, parallel = false }

#
# Language tests
#
[tasks.test-lang]
category = "CI - LANGUAGE TESTS"
description = "Run SurrealQL language tests with specified engine"
script = """
    #!/bin/bash -ex
    cd crates/language-tests
    if [ "${_TEST_LANG_FEATURES}" != "" ]; then
        cargo build --features ${_TEST_LANG_FEATURES}
    else
        cargo build
    fi
    if [ "${_TEST_API_ENGINE}" = "tikv" ] || [ "${_TEST_API_ENGINE}" = "foundation" ]; then
        ./target/debug/surrealql-test --color always run --no-wip -j 1 --backend ${_TEST_API_ENGINE}
    else
        ./target/debug/surrealql-test --color always run --no-wip -j 3 --backend ${_TEST_API_ENGINE}
    fi
"""

[tasks.ci-lang-test-mem]
category = "CI - LANGUAGE TESTS"
env = { _TEST_API_ENGINE = "memory", _TEST_LANG_FEATURES = "" }
run_task = { name = [
    "test-lang",
], fork = true, parallel = true }

[tasks.ci-lang-test-rocksdb]
category = "CI - LANGUAGE TESTS"
env = { _TEST_API_ENGINE = "rocksdb", _TEST_LANG_FEATURES = "backend-rocksdb" }
run_task = { name = [
    "test-lang",
], fork = true, parallel = true }

[tasks.ci-lang-test-surrealkv]
category = "CI - LANGUAGE TESTS"
env = { _TEST_API_ENGINE = "surrealkv", _TEST_LANG_FEATURES = "backend-surrealkv" }
run_task = { name = [
    "test-lang",
], fork = true, parallel = false }

[tasks.ci-lang-test-tikv]
category = "CI - LANGUAGE TESTS"
env = { _TEST_API_ENGINE = "tikv", _TEST_LANG_FEATURES = "backend-tikv" }
run_task = { name = [
    "start-tikv",
    "test-lang",
    "stop-tikv",
], fork = true, parallel = false }

[tasks.ci-lang-test-fdb]
category = "CI - LANGUAGE TESTS"
env = { _TEST_API_ENGINE = "foundation", _TEST_LANG_FEATURES = "backend-foundation" }
run_task = { name = [
    "test-lang",
], fork = true, parallel = false }

[tasks.ci-lang-test-all]
category = "CI - LANGUAGE TESTS"
description = "Run all language tests"
dependencies = [
    "ci-lang-test-mem",
    "ci-lang-test-rocksdb",
    "ci-lang-test-surrealkv",
    "ci-lang-test-tikv",
    "ci-lang-test-fdb",
]

#
# Services
#
[tasks.start-surrealdb]
category = "CI - SERVICES"
dependencies = ["build-surrealdb"]
script = """
    #!/bin/bash -ex


    target/debug/surreal start ${_START_SURREALDB_PATH} --allow-all &>/tmp/surrealdb-${_TEST_API_ENGINE}.log &

    echo $! > /tmp/surreal-${_TEST_API_ENGINE}.pid

    set +e
    echo "Waiting for surreal to be ready..."
    tries=0
    while [[ $tries < 5 ]]; do
            target/debug/surreal is-ready 2>/dev/null && echo "Ready!" && exit 0 || sleep 1
            tries=$((tries + 1))
    done

    echo "ERROR: Surreal is unhealthy!"
    exit 1
"""

[tasks.stop-surrealdb]
category = "CI - SERVICES"
script = """
    kill $(cat /tmp/surreal-${_TEST_API_ENGINE}.pid) || true
    sleep 5
    kill -9 $(cat /tmp/surreal-${_TEST_API_ENGINE}.pid) || true
"""

[tasks.start-tikv]
category = "CI - SERVICES"
script = """
    #!/bin/bash -ex

	echo "Installing TiKV playground..."
    ${HOME}/.tiup/bin/tiup install pd tikv playground

    echo "Cleaning TiKV playground..."
    ${HOME}/.tiup/bin/tiup clean --all
    killall -q tiup-playground || true
    rm -rf ${HOME}/.tiup/data/testing

	echo "Starting TiKV playground..."
	nohup ${HOME}/.tiup/bin/tiup playground --mode tikv-slim --kv 1 --pd 1 --db 0 --ticdc 0 --tiflash 0 --without-monitor --tag "testing" > /tmp/tiup.log &

    set +e
	tries=0
	echo "Waiting for TiKV playground to start..."
	while [[ $tries -lt 5 ]]; do
		sleep 5
		echo "Displaying playground status..."
		if ! ${HOME}/.tiup/bin/tiup playground display >/dev/null; then
			tries=$((tries + 1));
			continue
		fi
		exit 0;
	done

	echo "PANIC: Couldn't start TiKV playground! Here are the logs for the last attempt:"
    cat /tmp/tiup.log

    exit 1
"""

[tasks.stop-tikv]
category = "CI - SERVICES"
script = """
    #!/bin/bash -ex

    echo "Cleaning TiKV playground..."
    ${HOME}/.tiup/bin/tiup clean --all
    killall -q tiup-playground || true
    rm -rf ${HOME}/.tiup/data/testing

    set +e
	tries=0
	echo "Waiting for TiKV playground to stop..."
	while [[ $tries -lt 5 ]]; do
		sleep 5
		echo "Displaying playground status..."
		if ${HOME}/.tiup/bin/tiup playground display >/dev/null; then
			tries=$((tries + 1));
			continue
		fi
		exit 0;
	done

	echo "PANIC: Couldn't stop TiKV playground! Here are the logs for the last attempt:"
    cat /tmp/tiup.log

    exit 1
"""

[tasks.clear-fdb]
category = "CI - SERVICES"
command = "fdbcli"
args = [
    "-C",
    "/etc/foundationdb/fdb.cluster",
    "--exec",
    "writemode on; clearrange \"\" \\xFF",
    "--timeout",
    "20",
]

#
# Builds
#

[tasks.build-surrealdb]
category = "CI - BUILD"
command = "cargo"
args = [
    "build",
    "--locked",
    "--no-default-features",
    "--features",
    "storage-mem",
]

#
# Benchmarks - Common
#

[tasks.ci-bench]
category = "CI - BENCHMARK"
command = "cargo"
args = [
    "bench",
    "--quiet",
    "--package",
    "surrealdb",
    "--no-default-features",
    "--features",
    "kv-mem,scripting,http,jwks",
    "${@}",
]

#
# Benchmarks - SDB - Per Target
#

[tasks.bench-target]
private = true
category = "CI - BENCHMARK - SurrealDB Target"
command = "cargo"
args = [
    "bench",
    "--package",
    "surrealdb",
    "--bench",
    "sdb",
    "--no-default-features",
    "--features",
    "${BENCH_FEATURES}",
    "${@}",
]

[tasks.bench-lib-mem]
category = "CI - BENCHMARK - SurrealDB Target"
env = { BENCH_DATASTORE_TARGET = "lib-mem" }
run_task = { name = ["bench-target"] }

[tasks.bench-lib-rocksdb]
category = "CI - BENCHMARK - SurrealDB Target"
env = { BENCH_DATASTORE_TARGET = "lib-rocksdb" }
run_task = { name = ["bench-target"] }

[tasks.bench-lib-surrealkv]
category = "CI - BENCHMARK - SurrealDB Target"
env = { BENCH_DATASTORE_TARGET = "lib-surrealkv" }
run_task = { name = ["bench-target"] }

[tasks.bench-sdk-mem]
category = "CI - BENCHMARK - SurrealDB Target"
env = { BENCH_DATASTORE_TARGET = "sdk-mem" }
run_task = { name = ["bench-target"] }

[tasks.bench-sdk-rocksdb]
category = "CI - BENCHMARK - SurrealDB Target"
env = { BENCH_DATASTORE_TARGET = "sdk-rocksdb" }
run_task = { name = ["bench-target"] }

[tasks.bench-sdk-surrealkv]
category = "CI - BENCHMARK - SurrealDB Target"
env = { BENCH_DATASTORE_TARGET = "sdk-surrealkv" }
run_task = { name = ["bench-target"] }

[tasks.bench-sdk-ws]
category = "CI - BENCHMARK - SurrealDB Target"
env = { BENCH_DATASTORE_TARGET = "sdk-ws" }
run_task = { name = ["bench-target"] }

#
# Comprehensive CI check - runs all required checks for PR merge
#

[tasks.ci-sdk-tests]
category = "CI - INTEGRATION TESTS"
dependencies = [
    "ci-api-integration-mem",
    "ci-api-integration-any",
    "ci-api-integration-http",
    "ci-api-integration-ws",
]



[tasks.ci-sdk-build]
category = "CI - INTEGRATION TESTS"
description = "Build SDK test projects"
script = """
    #!/bin/bash -e
    echo "Building SDK local tests..."
    cd tests/sdk/local
    cargo build

    echo "Building SDK remote tests..."
    cd ../remote
    cargo build
"""

[tasks.ci-all-required]
category = "CI - ALL REQUIRED CHECKS"
description = "Run all required CI checks that must pass for PR merge (excludes tikv/fdb which require external services)"
dependencies = [
    # Code quality checks
    "ci-format",
    "ci-clippy",
    "ci-clippy-release",
    "ci-check",
    "ci-check-release",
    "ci-check-wasm",
    "ci-docs",
    # Integration tests
    "ci-cli-integration",
    "ci-http-integration",
    "ci-ws-integration",
    "ci-ml-integration",
    # Workspace tests (use ci-test-workspace instead of ci-workspace-coverage to skip coverage overhead)
    "ci-test-workspace",
    # KVS tests (local engines only - tikv/fdb require external services)
    "ci-mem-kvs",
    "ci-rocksdb-kvs",
    "ci-surrealkv-kvs",
    # SDK build tests
    "ci-sdk-build",
    # SDK tests (local engines only - tikv/fdb require external services)
    "ci-api-integration-mem",
    "ci-api-integration-rocksdb",
    "ci-api-integration-surrealkv",
    "ci-api-integration-http",
    "ci-api-integration-ws",
    "ci-api-integration-any",
]

[tasks.ci-all-required-with-lang]
category = "CI - ALL REQUIRED CHECKS"
description = "Run all required CI checks including SurrealQL language tests"
script = """
    #!/bin/bash -e

    # Run all standard required checks
    cargo make ci-all-required

    # Run SurrealQL language tests
    echo "Running SurrealQL language tests..."
    cd crates/language-tests
    cargo build
    ./target/debug/surrealql-test --color always run --no-wip -j 3
"""
